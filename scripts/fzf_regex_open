#!/bin/bash

if [ -z "$1" ]; then
    echo "Usage: opr <regex>"
    exit 1
fi

regex="$1"

rg --no-heading --line-number "$regex" . | cut -d':' -f1-2 | sort | fzf \
    --preview "file=\$(echo {} | cut -d: -f1); \
               line=\$(echo {} | cut -d: -f2); \
               if [ -n \"\$line\" ]; then \
                   start_line=\$((line > 2 ? line - 2 : 1)); \
                   batcat --style=numbers --color=always --highlight-line=\$line \"\$file\" -r \$start_line:; \
               else \
                   echo 'No match found in preview'; \
               fi" \
    --layout=reverse \
    --preview-window=up:40% \
    --bind "enter:execute(file=\$(echo {} | cut -d: -f1); \
            line=\$(echo {} | cut -d: -f2); \
            hx \"\$file\" +\$line)"

printf '\033[0 q'
